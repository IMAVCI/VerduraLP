import React, { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";

/**
 * Versión FINAL del Inventario:
 * 1. Pestañas independientes: "Orden" y "Actualizar" con sus datos propios.
 * 2. "Editar" trabaja sobre los items de "Actualizar".
 * 3. Tres vistas: "Lista sin imágenes", "Lista con imágenes" y "Grilla con imágenes".
 * 4. Animaciones modernas con Framer Motion.
 * 
 * Ahora, iniciamos directamente en "list-images" (vista con imágenes)
 * y usamos placehold.co para las URLs de las imágenes.
 */

export default function InventoryPreview() {
  // Estado para "orden"
  const [ordenItems, setOrdenItems] = useState({
    "AGUACATES": {
      qty: 60,
      unit: "pz",
      image: "https://placehold.co/120?text=Aguacate",
      category: "Frutas"
    },
    "AJO EN PAQUETE": {
      qty: 60,
      unit: "pz",
      image: "https://placehold.co/120?text=Ajo+Paquete",
      category: "Especias"
    },
    "AJO SUELTO": {
      qty: 28.5,
      unit: "pz",
      image: "https://placehold.co/120?text=Ajo+Suelto",
      category: "Especias"
    },
  });

  // Estado para "actualizar"
  const [actualizarItems, setActualizarItems] = useState({
    "AGUACATES": {
      qty: 10,
      unit: "pz",
      image: "https://placehold.co/120?text=Aguacate",
      category: "Frutas"
    },
    "AJO EN PAQUETE": {
      qty: 5,
      unit: "pz",
      image: "https://placehold.co/120?text=Ajo+Paquete",
      category: "Especias"
    },
    "AJO SUELTO": {
      qty: 2.5,
      unit: "pz",
      image: "https://placehold.co/120?text=Ajo+Suelto",
      category: "Especias"
    },
  });

  // Pestaña actual
  const [currentTab, setCurrentTab] = useState("orden");

  /**
   * Vistas disponibles:
   * 1. 'list-no-images'   -> lista sin imágenes
   * 2. 'list-images'      -> lista con imágenes
   * 3. 'grid-images'      -> grilla con imágenes
   * 
   * Iniciamos en 'list-images' (para que se muestren desde el principio)
   */
  const [currentView, setCurrentView] = useState("list-images");
  const [viewMenuOpen, setViewMenuOpen] = useState(false);

  // Modal para editar SOLO items de "actualizar".
  const [currentEdit, setCurrentEdit] = useState(null);
  const [editName, setEditName] = useState("");
  const [editImageUrl, setEditImageUrl] = useState("");
  const [editCategory, setEditCategory] = useState("Frutas");

  // Al montar, revisa localStorage
  useEffect(() => {
    const savedOrden = localStorage.getItem("inventory_orden");
    if (savedOrden) {
      setOrdenItems(JSON.parse(savedOrden));
    }

    const savedActualizar = localStorage.getItem("inventory_actualizar");
    if (savedActualizar) {
      setActualizarItems(JSON.parse(savedActualizar));
    }
  }, []);

  // Guarda en localStorage cada vez que cambie
  useEffect(() => {
    localStorage.setItem("inventory_orden", JSON.stringify(ordenItems));
  }, [ordenItems]);

  useEffect(() => {
    localStorage.setItem("inventory_actualizar", JSON.stringify(actualizarItems));
  }, [actualizarItems]);

  // Cambiar de pestaña
  function showTab(tabName) {
    setCurrentTab(tabName);
  }

  // Menú de vistas
  function toggleViewMenu() {
    setViewMenuOpen((prev) => !prev);
  }

  // Ajustar vista y cerrar el menú
  function handleViewChange(view) {
    setCurrentView(view);
    setViewMenuOpen(false);
  }

  // Actualiza qty en "Orden"
  function updateOrdenQuantity(name, value) {
    setOrdenItems((prev) => ({
      ...prev,
      [name]: {
        ...prev[name],
        qty: Number(value) || 0,
      },
    }));
  }

  // Actualiza qty en "Actualizar"
  function updateActualizarQuantity(name, value) {
    setActualizarItems((prev) => ({
      ...prev,
      [name]: {
        ...prev[name],
        qty: Number(value) || 0,
      },
    }));
  }

  // Edita items de "Actualizar"
  function handleEdit(name) {
    setCurrentEdit(name);
    setEditName(name);
    setEditImageUrl(actualizarItems[name].image || "");
    setEditCategory(actualizarItems[name].category || "Frutas");
  }

  function closeModal() {
    setCurrentEdit(null);
    const fileInput = document.getElementById("editImageFile");
    if (fileInput) fileInput.value = "";
  }

  function saveChanges() {
    if (!currentEdit) return;
    const fileInput = document.getElementById("editImageFile");
    const imageFile = fileInput && fileInput.files[0];

    if (imageFile) {
      const reader = new FileReader();
      reader.onload = (e) => {
        setActualizarItems((prev) => ({
          ...prev,
          [currentEdit]: {
            ...prev[currentEdit],
            image: e.target.result,
            category: editCategory,
          },
        }));
        closeModal();
      };
      reader.readAsDataURL(imageFile);
    } else {
      setActualizarItems((prev) => ({
        ...prev,
        [currentEdit]: {
          ...prev[currentEdit],
          image: editImageUrl || "",
          category: editCategory,
        },
      }));
      closeModal();
    }
  }

  // Eliminar en "Actualizar"
  function deleteItem() {
    if (!currentEdit) return;
    setActualizarItems((prev) => {
      const updated = { ...prev };
      delete updated[currentEdit];
      return updated;
    });
    closeModal();
  }

  // Compartir (une ambos inventarios)
  function compartir() {
    let msg = "Inventario de Verduras:\n\n";

    msg += "[ORDEN]\n";
    Object.entries(ordenItems)
      .filter(([_, data]) => data.qty > 0)
      .forEach(([name, data]) => {
        msg += `${name}: ${data.qty} ${data.unit} (${data.category})\n`;
      });

    msg += "\n[ACTUALIZAR]\n";
    Object.entries(actualizarItems)
      .filter(([_, data]) => data.qty > 0)
      .forEach(([name, data]) => {
        msg += `${name}: ${data.qty} ${data.unit} (${data.category})\n`;
      });

    if (navigator.share) {
      navigator.share({ text: msg });
    } else {
      window.location.href = `whatsapp://send?text=${encodeURIComponent(msg)}`;
    }
  }

  // =====================
  // RENDER TABS
  // =====================
  function renderOrdenTab() {
    // Muestra imágenes SÓLO en "list-images" o "grid-images"
    const showImages = currentView === "list-images" || currentView === "grid-images";
    return (
      <ItemGrid
        items={ordenItems}
        showImage={showImages}
        updateQuantity={updateOrdenQuantity}
        isGrid={currentView === "grid-images"}
        isOrden
      />
    );
  }

  function renderActualizarTab() {
    // Muestra imágenes SÓLO en "list-images" o "grid-images"
    const showImages = currentView === "list-images" || currentView === "grid-images";
    return (
      <ItemGrid
        items={actualizarItems}
        showImage={showImages}
        updateQuantity={updateActualizarQuantity}
        isActualizar
        isGrid={currentView === "grid-images"}
      />
    );
  }

  // "Editar" gestiona items de "Actualizar"
  function renderEditarTab() {
    // Muestra imágenes SÓLO en "list-images" o "grid-images"
    const showImages = currentView === "list-images" || currentView === "grid-images";
    return (
      <ItemGrid
        items={actualizarItems}
        showImage={showImages}
        onEdit={handleEdit}
        isEditar
        isGrid={currentView === "grid-images"}
      />
    );
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header con animación & gradient */}
      <motion.div
        initial={{ opacity: 0, y: -30 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.4 }}
        className="bg-gradient-to-r from-green-700 via-green-600 to-green-500 text-white p-4 fixed top-0 w-full z-10 shadow flex justify-center"
      >
        <h2 className="text-xl font-bold tracking-wide">Inventario de Verduras</h2>
      </motion.div>

      {/* Tabs */}
      <div className="fixed top-[60px] w-full flex justify-around bg-white shadow z-10">
        {["orden", "actualizar", "editar"].map((tab) => (
          <motion.div
            key={tab}
            onClick={() => showTab(tab)}
            className={`
              py-3 px-5 cursor-pointer border-b-2 transition-colors 
              ${
                currentTab === tab
                  ? "border-green-700 text-green-700 font-semibold"
                  : "border-transparent text-green-700"
              }
            `}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            {tab.charAt(0).toUpperCase() + tab.slice(1)}
          </motion.div>
        ))}
      </div>

      {/* Botón de Vista estilo Microsoft */}
      <div className="fixed top-[110px] w-full bg-white shadow z-10 py-2 flex justify-center">
        <div className="relative">
          <motion.button
            onClick={toggleViewMenu}
            className="flex items-center gap-1 px-4 py-2 bg-gray-100 rounded-full text-gray-700 shadow hover:shadow-md transition"
            whileTap={{ scale: 0.96 }}
            whileHover={{ scale: 1.03 }}
          >
            <span className="font-medium">Vista</span>
            {/* Icono caret */}
            <svg
              className="w-4 h-4"
              fill="none"
              stroke="currentColor"
              strokeWidth={2}
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </motion.button>

          <AnimatePresence>
            {viewMenuOpen && (
              <motion.div
                initial={{ opacity: 0, y: 5 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: 5 }}
                className="absolute mt-2 bg-white border border-gray-200 rounded shadow-lg w-56 right-0 z-20"
              >
                <MenuButton
                  currentView={currentView}
                  targetView="list-no-images"
                  onClick={handleViewChange}
                  icon={
                    <svg
                      className="w-5 h-5 text-gray-600"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth={2}
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M4 6h16M4 12h16M4 18h16"
                      />
                    </svg>
                  }
                >
                  Lista (sin imágenes)
                </MenuButton>

                <MenuButton
                  currentView={currentView}
                  targetView="list-images"
                  onClick={handleViewChange}
                  icon={
                    <svg
                      className="w-5 h-5 text-gray-600"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth={2}
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M4 6h9m2 0h5M4 12h16M4 18h16M8 12l2.5-2.5c.66-.66 1.74-.66 2.4 0L15 12"
                      />
                    </svg>
                  }
                >
                  Lista (con imágenes)
                </MenuButton>

                <MenuButton
                  currentView={currentView}
                  targetView="grid-images"
                  onClick={handleViewChange}
                  icon={
                    <svg
                      className="w-5 h-5 text-gray-600"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth={2}
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M3 3h7v7H3V3zm0 11h7v7H3v-7zm11-11h7v7h-7V3zm0 11h7v7h-7v-7z"
                      />
                    </svg>
                  }
                >
                  Grilla (con imágenes)
                </MenuButton>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>

      {/* Contenido según la pestaña */}
      <div className="mt-[160px] mb-[80px] max-w-xl mx-auto px-4">
        <AnimatePresence mode="wait">
          {currentTab === "orden" && (
            <motion.div
              key="ordenTab"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
            >
              {renderOrdenTab()}
            </motion.div>
          )}
          {currentTab === "actualizar" && (
            <motion.div
              key="actualizarTab"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
            >
              {renderActualizarTab()}
            </motion.div>
          )}
          {currentTab === "editar" && (
            <motion.div
              key="editarTab"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
            >
              {renderEditarTab()}
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Botón para compartir */}
      <motion.div
        className="fixed bottom-0 w-full bg-white shadow p-3 flex justify-center"
        initial={{ y: 40, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.2 }}
      >
        <motion.button
          onClick={compartir}
          className="bg-green-700 text-white px-6 py-2 rounded-full shadow-lg hover:shadow-xl transition"
          whileTap={{ scale: 0.95 }}
        >
          Compartir
        </motion.button>
      </motion.div>

      {/* Modal de Edición (para actualizarItems) */}
      <AnimatePresence>
        {currentEdit && (
          <motion.div
            className="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-20 backdrop-blur-sm"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            <motion.div
              className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl relative"
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.8, opacity: 0 }}
            >
              <h3 className="text-lg font-semibold mb-4">Editar Producto</h3>
              <input
                type="text"
                className="w-full mb-3 p-2 border rounded"
                value={editName}
                readOnly
              />
              <input
                type="file"
                id="editImageFile"
                accept="image/*"
                className="w-full mb-3 p-2 border rounded"
              />
              <input
                type="text"
                className="w-full mb-3 p-2 border rounded"
                placeholder="URL de la imagen"
                value={editImageUrl}
                onChange={(e) => setEditImageUrl(e.target.value)}
              />
              <select
                className="w-full mb-3 p-2 border rounded"
                value={editCategory}
                onChange={(e) => setEditCategory(e.target.value)}
              >
                <option value="Frutas">Frutas</option>
                <option value="Verduras">Verduras</option>
                <option value="Especias">Especias</option>
              </select>

              <div className="flex gap-2 mt-4">
                <motion.button
                  onClick={deleteItem}
                  className="flex-1 bg-red-600 text-white py-2 rounded-full"
                  whileTap={{ scale: 0.95 }}
                >
                  Eliminar
                </motion.button>
                <motion.button
                  onClick={closeModal}
                  className="flex-1 bg-gray-400 text-white py-2 rounded-full"
                  whileTap={{ scale: 0.95 }}
                >
                  Cancelar
                </motion.button>
                <motion.button
                  onClick={saveChanges}
                  className="flex-1 bg-green-700 text-white py-2 rounded-full"
                  whileTap={{ scale: 0.95 }}
                >
                  Guardar
                </motion.button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

/************************************
 *  Subcomponente ItemGrid
 ************************************/
function ItemGrid({ items, showImage, updateQuantity, onEdit, isEditar, isActualizar, isGrid }) {
  // Determinamos el step para la cantidad
  const stepValue = isActualizar ? 0.1 : 1;

  // Clases del contenedor según grilla/lista
  const containerClass = isGrid ? "grid grid-cols-2 gap-4" : "flex flex-col gap-4";

  return (
    <motion.div layout className={containerClass}>
      <AnimatePresence>
        {Object.entries(items).map(([name, data]) => (
          <motion.div
            key={name}
            layout
            initial={{ opacity: 0, y: 20, scale: 0.95 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            transition={{ duration: 0.3 }}
            className="bg-white p-4 rounded-xl shadow-sm text-center flex flex-col items-center justify-center hover:shadow-md hover:-translate-y-1 transition"
          >
            {/* Imagen (si la vista lo permite y hay image) */}
            {showImage && data.image && (
              <motion.img
                src={data.image}
                alt={name}
                className="w-full h-32 object-contain bg-gray-100 rounded-xl mb-2"
                onError={(e) => (e.currentTarget.style.display = "none")}
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ duration: 0.3 }}
              />
            )}

            <div className="font-semibold mb-2">{name}</div>

            {/* Si estamos en Editar, mostramos el botón Editar; si no, input de cantidad */}
            {isEditar ? (
              <motion.button
                onClick={() => onEdit && onEdit(name)}
                className="text-green-700 bg-gray-100 px-4 py-1 rounded-full mt-2 shadow-sm hover:shadow-md transition"
                whileTap={{ scale: 0.95 }}
              >
                Editar
              </motion.button>
            ) : (
              <div className="flex items-center justify-center gap-2">
                {updateQuantity && (
                  <input
                    type="number"
                    value={data.qty}
                    step={stepValue}
                    onFocus={(e) => e.target.select()}
                    onChange={(e) => updateQuantity(name, e.target.value)}
                    className="w-20 p-2 border rounded-md text-center"
                  />
                )}
                <span>{isActualizar ? data.unit : "Cajas"}</span>
              </div>
            )}
          </motion.div>
        ))}
      </AnimatePresence>
    </motion.div>
  );
}

/************************************
 *  Subcomponente MenuButton
 ************************************/
function MenuButton({ children, icon, currentView, targetView, onClick }) {
  return (
    <motion.button
      onClick={() => onClick(targetView)}
      className={`block w-full text-left px-4 py-2 hover:bg-gray-100 ${
        currentView === targetView ? "bg-green-50" : ""
      }`}
      whileTap={{ scale: 0.97 }}
    >
      <div className="flex items-center gap-2">
        {icon}
        <span>{children}</span>
      </div>
    </motion.button>
  );
}
